<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Distorting Hat™ - Where Souls Get Sorted Wrong</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Montserrat:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(45deg, #0f001a, #1a0033, #0a1420, #1a1030, #0f001a);
            background-size: 400% 400%;
            animation: gradientShift 12s ease infinite;
            font-family: 'Montserrat', sans-serif;
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        /* Intro Scene Styles */
        .intro-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000 0%, #1a0033 30%, #4a0080 60%, #000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 2s ease-out, transform 2s ease-out;
        }

        .intro-overlay.fade-out {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .distorting-hat {
            width: 150px;
            height: 150px;
            position: relative;
            margin-bottom: 40px;
            cursor: pointer;
            animation: hatAwaken 3s ease-in-out infinite;
        }

        .hat-body {
            width: 100%;
            height: 120px;
            background: linear-gradient(45deg, #2c1810, #1a0f08, #4a2c1a);
            border-radius: 50% 50% 60% 40% / 80% 80% 20% 20%;
            position: relative;
            box-shadow: 
                0 0 30px rgba(204, 74, 122, 0.5),
                inset 0 0 20px rgba(0, 0, 0, 0.8);
            animation: hatGlow 2s ease-in-out infinite alternate;
        }

        .hat-brim {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 180px;
            height: 40px;
            background: linear-gradient(45deg, #1a0f08, #2c1810);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
        }

        .hat-eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
        }

        .hat-eye {
            width: 15px;
            height: 15px;
            background: #ff6b6b;
            border-radius: 50%;
            box-shadow: 0 0 10px #ff6b6b;
            animation: eyeBlink 4s ease-in-out infinite;
        }

        .hat-mouth {
            position: absolute;
            bottom: 30%;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            border: 3px solid #ff6b6b;
            border-top: none;
            border-radius: 0 0 40px 40px;
            animation: mouthTalk 1.5s ease-in-out infinite;
        }

        @keyframes hatAwaken {
            0%, 100% { transform: rotate(-2deg) scale(1); }
            50% { transform: rotate(2deg) scale(1.05); }
        }

        @keyframes hatGlow {
            0% { box-shadow: 0 0 30px rgba(204, 74, 122, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.8); }
            100% { box-shadow: 0 0 50px rgba(204, 74, 122, 0.8), inset 0 0 30px rgba(0, 0, 0, 0.6); }
        }

        @keyframes eyeBlink {
            0%, 90%, 100% { opacity: 1; transform: scaleY(1); }
            95% { opacity: 0.3; transform: scaleY(0.1); }
        }

        @keyframes mouthTalk {
            0%, 100% { transform: translateX(-50%) scaleY(1); }
            50% { transform: translateX(-50%) scaleY(1.3); }
        }

        .intro-text {
            color: #cc4a7a;
            text-align: center;
            font-size: clamp(1.5em, 6vw, 2.5em);
            font-family: 'Creepster', cursive;
            text-shadow: 0 0 20px rgba(204, 74, 122, 0.8);
            margin-bottom: 20px;
            animation: textFlicker 2s ease-in-out infinite;
            line-height: 1.2;
        }

        .intro-subtitle {
            color: rgba(230, 230, 250, 0.9);
            text-align: center;
            font-size: clamp(0.9em, 3.5vw, 1.2em);
            font-style: italic;
            text-shadow: 0 0 10px rgba(230, 230, 250, 0.5);
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.4;
        }

        .intro-prompt {
            color: rgba(255, 255, 255, 0.8);
            font-size: clamp(0.8em, 3vw, 1em);
            text-align: center;
            animation: pulsePrompt 2s ease-in-out infinite;
            margin-top: 20px;
        }

        @keyframes textFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            60% { opacity: 1; }
            80% { opacity: 0.9; }
        }

        @keyframes pulsePrompt {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Orientation Modal */
        .orientation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .orientation-modal.show {
            display: flex;
            animation: modalSlideIn 0.8s ease-out;
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #cc4a7a;
            border-radius: 20px;
            padding: 30px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            text-align: center;
            box-shadow: 0 0 40px rgba(204, 74, 122, 0.6);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #cc4a7a, #8A2BE2, #FF1493, #cc4a7a);
            background-size: 400% 400%;
            border-radius: 23px;
            z-index: -1;
            animation: gradientShift 3s ease infinite;
        }

        .modal-title {
            font-family: 'Creepster', cursive;
            font-size: clamp(1.5em, 5vw, 2em);
            color: #cc4a7a;
            margin-bottom: 20px;
            text-shadow: 0 0 15px rgba(204, 74, 122, 0.8);
        }

        .modal-text {
            font-size: clamp(0.9em, 3.5vw, 1.1em);
            line-height: 1.6;
            color: #e0e0e0;
            margin-bottom: 25px;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* Mobile HUD Improvements */
        .hud-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .hud-toggle {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            background: rgba(204, 74, 122, 0.8);
            border: 2px solid #cc4a7a;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            color: white;
            z-index: 1001;
        }

        .hud-content {
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border-radius: 15px;
            border: 2px solid #cc4a7a;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .hud-collapsed {
            transform: scale(0);
            opacity: 0;
            pointer-events: none;
        }

        /* Enhanced Dialogue System */
        .hat-dialogue-container {
            position: relative;
            margin-bottom: 20px;
        }

        .hat-speech-bubble {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(26, 0, 51, 0.9));
            color: #ffd700;
            padding: 15px 20px;
            border-radius: 20px;
            border: 2px solid #ffd700;
            font-size: clamp(0.8em, 3.5vw, 1em);
            max-width: 280px;
            text-align: center;
            line-height: 1.4;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            opacity: 0;
            transform: translateX(-50%) translateY(10px) scale(0.8);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .hat-speech-bubble.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .hat-speech-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 12px solid transparent;
            border-top-color: #ffd700;
        }

        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ffd700;
            animation: typingDots 1.4s infinite;
        }

        .typing-indicator:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingDots {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Enhanced Container and Layout */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
            z-index: 2;
        }
        
        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }
        
        .floating-pill {
            position: absolute;
            background: rgba(255, 100, 150, 0.3);
            border-radius: 50px;
            animation: float 6s ease-in-out infinite;
        }
        
        .floating-pill:nth-child(1) { width: 30px; height: 15px; top: 10%; left: 10%; animation-delay: 0s; }
        .floating-pill:nth-child(2) { width: 25px; height: 12px; top: 30%; right: 15%; animation-delay: 2s; }
        .floating-pill:nth-child(3) { width: 35px; height: 18px; bottom: 20%; left: 20%; animation-delay: 4s; }
        .floating-pill:nth-child(4) { width: 20px; height: 10px; top: 60%; right: 30%; animation-delay: 1s; }
        .floating-pill:nth-child(5) { width: 28px; height: 14px; top: 80%; left: 60%; animation-delay: 3s; }
        .floating-pill:nth-child(6) { width: 22px; height: 11px; top: 50%; left: 5%; animation-delay: 5s; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-30px) rotate(180deg); opacity: 0.8; }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 20px;
            border: 2px solid #cc4a7a;
            box-shadow: 0 0 25px rgba(204, 74, 122, 0.2);
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #cc4a7a, #3bb3a8, #3590c4, #7da89a, #d18a1f, #cc4a7a);
            background-size: 400% 400%;
            border-radius: 23px;
            z-index: -1;
            animation: gradientShift 3s ease infinite;
        }
        
        .title {
            font-family: 'Creepster', cursive;
            font-size: clamp(2em, 8vw, 3.5em);
            color: #cc4a7a;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 15px;
            position: relative;
            line-height: 1.2;
            font-weight: 700;
            letter-spacing: 0.5px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .title::after {
            content: '™';
            font-size: 0.3em;
            position: absolute;
            top: 0;
            right: -10px;
            color: #cc4a7a;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .subtitle {
            font-size: clamp(0.9em, 4vw, 1.2em);
            color: #a8a8e0;
            font-style: italic;
            margin-bottom: 20px;
            line-height: 1.3;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
            font-weight: 400;
        }
        
        .intro-text {
            font-size: clamp(0.85em, 3.5vw, 1em);
            line-height: 1.6;
            color: #f0f0f0;
            margin: 0 auto 20px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            font-weight: 400;
        }
        
        .disclaimer {
            font-size: clamp(0.75em, 3vw, 0.8em);
            color: #d0d0d0;
            font-style: italic;
            margin-top: 15px;
            opacity: 0.95;
            line-height: 1.4;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            font-weight: 300;
        }
        
        .quiz-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #4a4a4a;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
        }
        
        .quiz-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .question {
            margin-bottom: 30px;
            opacity: 0;
            animation: fadeInUp 0.5s ease forwards;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .question-text {
            font-size: clamp(1.1em, 4.5vw, 1.3em);
            color: #ff9f43;
            margin-bottom: 20px;
            font-weight: 600;
            position: relative;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .question-number {
            position: absolute;
            top: -10px;
            right: 0;
            background: #cc4a7a;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.7em;
            font-weight: bold;
            text-shadow: none;
        }
        
        .options {
            display: grid;
            gap: 15px;
        }
        
        .option {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 2px solid #555;
            border-radius: 15px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(0.9em, 3.5vw, 1em);
            color: #ecf0f1;
            position: relative;
            overflow: hidden;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            min-height: 60px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .option:hover::before,
        .option:active::before {
            left: 100%;
        }
        
        .option:hover,
        .option:active {
            background: linear-gradient(135deg, #335066, #7aa5c4);
            border-color: #cc4a7a;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(204, 74, 122, 0.3);
        }
        
        .option.selected {
            background: linear-gradient(135deg, #cc4a7a, #a63857);
            border-color: #cc4a7a;
            color: white;
            transform: scale(1.02);
            box-shadow: 0 0 25px rgba(204, 74, 122, 0.5);
        }
        
        .option.selected::after {
            content: '✓';
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.4em;
            font-weight: bold;
        }

        /* Enhanced Result Reveal */
        .result-container {
            background: rgba(0, 0, 0, 0.95);
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            border: 3px solid;
            box-shadow: 0 0 40px;
            display: none;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            animation: resultReveal 1.5s ease-out;
        }

        @keyframes resultReveal {
            0% { 
                opacity: 0; 
                transform: scale(0.8) rotateY(-15deg); 
                filter: blur(10px);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05) rotateY(5deg); 
                filter: blur(2px);
            }
            100% { 
                opacity: 1; 
                transform: scale(1) rotateY(0deg); 
                filter: blur(0px);
            }
        }

        .result-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, currentColor, transparent);
            animation: rotate 4s linear infinite;
            opacity: 0.1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }

        .result-glitch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 2px,
                rgba(255, 0, 100, 0.03) 2px,
                rgba(255, 0, 100, 0.03) 4px
            );
            animation: glitchScan 2s infinite;
            pointer-events: none;
        }

        @keyframes glitchScan {
            0%, 100% { transform: translateX(0); opacity: 0; }
            10%, 90% { opacity: 1; }
            50% { transform: translateX(100%); }
        }
        
        .house-slackerin {
            border-color: #27ae60;
            box-shadow: 0 0 40px rgba(39, 174, 96, 0.4);
            color: #27ae60;
        }
        
        .house-overthinkledore {
            border-color: #3498db;
            box-shadow: 0 0 40px rgba(52, 152, 219, 0.4);
            color: #3498db;
        }
        
        .house-cryffindor {
            border-color: #e74c3c;
            box-shadow: 0 0 40px rgba(231, 76, 60, 0.4);
            color: #e74c3c;
        }
        
        .house-naptuffpuff {
            border-color: #f39c12;
            box-shadow: 0 0 40px rgba(243, 156, 18, 0.4);
            color: #f39c12;
        }
        
        .house-name {
            font-family: 'Creepster', cursive;
            font-size: clamp(2em, 8vw, 3em);
            margin-bottom: 20px;
            text-shadow: 0 0 15px currentColor;
            animation: nameGlow 2s ease-in-out infinite alternate, glitchText 3s infinite;
            line-height: 1.2;
            position: relative;
        }

        @keyframes nameGlow {
            from { text-shadow: 0 0 15px currentColor; }
            to { text-shadow: 0 0 25px currentColor, 0 0 35px currentColor; }
        }

        @keyframes glitchText {
            0%, 95% { transform: translate(0); }
            96% { transform: translate(2px, -1px); }
            97% { transform: translate(-1px, 2px); }
            98% { transform: translate(1px, 1px); }
            99% { transform: translate(0); }
        }
        
        .house-description {
            font-size: clamp(1em, 4vw, 1.2em);
            line-height: 1.6;
            margin-bottom: 30px;
            color: #e0e0e0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .house-motto {
            font-style: italic;
            font-size: clamp(0.95em, 4vw, 1.1em);
            opacity: 0.9;
            margin-bottom: 20px;
            color: #d0d0d0;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .house-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: statPulse 2s ease-in-out infinite;
        }

        @keyframes statPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .stat-label {
            font-size: clamp(0.8em, 3.5vw, 0.9em);
            opacity: 0.9;
            margin-bottom: 8px;
            color: #e0e0e0;
        }
        
        .stat-value {
            font-size: clamp(1em, 4vw, 1.2em);
            font-weight: bold;
            color: currentColor;
        }

        /* Screenshot Prompt */
        .screenshot-prompt {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(138, 43, 226, 0.9), rgba(255, 20, 147, 0.8));
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            font-size: clamp(0.8em, 3vw, 0.9em);
            text-align: center;
            z-index: 1500;
            animation: screenshotFloat 3s ease-in-out infinite;
            max-width: 90%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
        }

        .screenshot-prompt.show {
            opacity: 1;
            pointer-events: all;
            animation: screenshotSlideIn 0.8s ease-out, screenshotFloat 3s ease-in-out infinite 0.8s;
        }

        @keyframes screenshotSlideIn {
            from { opacity: 0; transform: translateX(-50%) translateY(-100%); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes screenshotFloat {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: clamp(0.95em, 4vw, 1.1em);
            font-weight: 600;
            padding: 15px 25px;
            transition: all 0.3s ease;
            margin: 8px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
            min-height: 50px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before,
        .btn:active::before {
            left: 100%;
        }
        
        .btn:hover,
        .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #cc4a7a, #3bb3a8, #3590c4);
            border-radius: 5px;
            transition: width 0.5s ease;
            width: 0%;
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: progressShimmer 1.5s infinite;
        }
        
        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .chaos-level {
            color: #cc4a7a;
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            font-size: clamp(0.75em, 3vw, 0.85em);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .chaos-bar {
            width: 80px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .chaos-fill {
            height: 100%;
            background: linear-gradient(90deg, #3bb3a8, #d18a1f, #cc4a7a);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .hat-animation {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #4a4a4a;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            animation: wobble 2s infinite;
            cursor: pointer;
        }
        
        .hat-animation.talking {
            animation: hatTalk 0.5s ease infinite;
        }
        
        @keyframes wobble {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        @keyframes hatTalk {
            0%, 100% { transform: rotate(-3deg) scaleY(1); }
            50% { transform: rotate(3deg) scaleY(1.1); }
        }
        
        .hat-animation::before {
            content: '';
            position: absolute;
            top: -16px;
            left: 30%;
            width: 40%;
            height: 32px;
            background: #4a4a4a;
            border-radius: 50px;
        }
        
        .hat-animation::after {
            content: '👁️';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            animation: blink 3s infinite;
        }
        
        @keyframes blink {
            0%, 90%, 100% { opacity: 1; }
            95% { opacity: 0; }
        }
        
        .sparkles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            animation: sparkle 2s infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        
        .hidden { display: none !important; }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .hud-toggle {
                display: flex;
            }
            
            .container { 
                padding: 10px; 
            }
            
            .header {
                padding: 20px 15px;
                margin-bottom: 25px;
                background: rgba(0, 0, 0, 0.95);
            }
            
            .title {
                font-size: clamp(1.8em, 7vw, 2.5em);
                text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.9);
                font-weight: 800;
                letter-spacing: 1px;
            }
            
            .quiz-container {
                padding: 20px 15px;
                border-radius: 15px;
            }
            
            .hud-content {
                display: flex;
                align-items: center;
                gap: 15px;
                width: 100%;
                justify-content: space-between;
            }
            
            .chaos-bar {
                width: 120px;
            }
            
            .house-stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stat-item {
                padding: 12px;
            }
            
            .options {
                gap: 12px;
            }
            
            .option {
                padding: 15px;
                min-height: 50px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
                padding: 18px 20px;
            }
            
            .result-container {
                padding: 25px 20px;
            }
            
            .hat-speech-bubble {
                max-width: 240px;
                font-size: 0.9em;
            }
            
            .distorting-hat {
                width: 120px;
                height: 120px;
            }
            
            .modal-content {
                padding: 25px 20px;
                max-width: 95%;
            }

            .screenshot-prompt {
                padding: 12px 20px;
                font-size: 0.85em;
            }
        }
        
        @media (max-width: 480px) {
            .title::after {
                right: -5px;
            }
            
            .question-number {
                position: static;
                display: inline-block;
                margin-bottom: 10px;
            }
            
            .hat-animation {
                width: 60px;
                height: 60px;
            }
            
            .hat-animation::before {
                top: -12px;
                height: 24px;
            }
            
            .floating-pill {
                display: none;
            }

            .distorting-hat {
                width: 100px;
                height: 100px;
            }

            .hat-speech-bubble {
                max-width: 200px;
                font-size: 0.8em;
                padding: 12px 16px;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .title {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .quiz-container {
                padding: 15px;
            }
            
            .hat-animation {
                width: 50px;
                height: 50px;
                margin-bottom: 15px;
            }

            .distorting-hat {
                width: 80px;
                height: 80px;
                margin-bottom: 20px;
            }

            .intro-text {
                font-size: 1.2em;
                margin-bottom: 15px;
            }

            .intro-subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .floating-pill, .sparkle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Intro Overlay -->
    <div class="intro-overlay" id="introOverlay">
        <div class="distorting-hat" id="distortingHat">
            <div class="hat-body">
                <div class="hat-eyes">
                    <div class="hat-eye"></div>
                    <div class="hat-eye"></div>
                </div>
                <div class="hat-mouth"></div>
            </div>
            <div class="hat-brim"></div>
        </div>
        <div class="intro-text">I see into your soul...</div>
        <div class="intro-subtitle">...but it's blurry. And concerning. And probably needs therapy.</div>
        <div class="intro-prompt">✨ Tap anywhere to begin the distortion ✨</div>
    </div>

    <!-- Orientation Modal -->
    <div class="orientation-modal" id="orientationModal">
        <div class="modal-content">
            <h2 class="modal-title">🎭 Welcome to Your Reckoning</h2>
            <p class="modal-text">
                You are about to be sorted. But this isn't Hogwarts—this is somewhere far weirder, where the Hat has been drinking existential dread and reading psychology papers at 3 AM.
            </p>
            <p class="modal-text">
                Your soul is not ready. Your mental defenses are down. And I can see everything.
            </p>
            <p class="modal-text">
                Prepare for aggressive personality categorization with a side of uncomfortable accuracy.
            </p>
            <button class="btn" id="beginDistortion">Begin the Beautiful Distortion</button>
        </div>
    </div>

    <!-- Screenshot Prompt -->
    <div class="screenshot-prompt" id="screenshotPrompt">
        📸 Your fate is sealed. Screenshot it before the hat changes its mind.
    </div>

    <!-- Floating Elements -->
    <div class="floating-elements">
        <div class="floating-pill"></div>
        <div class="floating-pill"></div>
        <div class="floating-pill"></div>
        <div class="floating-pill"></div>
        <div class="floating-pill"></div>
        <div class="floating-pill"></div>
    </div>
    
    <!-- Mobile HUD -->
    <div class="hud-container" id="hudContainer">
        <div class="hud-toggle" id="hudToggle">⏬</div>
        <div class="hud-content" id="hudContent">
            <div class="chaos-level">CHAOS: <span id="chaosLevel">0%</span></div>
            <div class="chaos-bar">
                <div class="chaos-fill" id="chaosFill"></div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1 class="title" id="mainTitle">The Distorting Hat</h1>
            <p class="subtitle">"Where souls get sorted wrong since whenever"</p>
            <p class="intro-text">
                Welcome to the most psychologically invasive sorting experience on the internet! 
                I'm a magical hat with trust issues, commitment problems, and an unhealthy obsession with categorizing people. 
                Results may include: existential dread, aggressive self-awareness, or the sudden urge to reorganize your entire personality.
            </p>
            <p class="disclaimer">
                *Not affiliated with actual magic schools. Side effects include: uncontrollable self-recognition, sudden clarity about your chaos patterns, and an inexplicable urge to share results with strangers on the internet.
            </p>
        </div>
        
        <div id="quizContainer" class="quiz-container">
            <div class="hat-dialogue-container">
                <div class="hat-animation" id="sortingHat">
                    <div class="hat-speech-bubble" id="hatSpeechBubble"></div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div id="questionContainer">
                <!-- Questions will be inserted here -->
            </div>
            
            <button id="nextBtn" class="btn hidden">Next Question</button>
            <button id="startBtn" class="btn">Begin the Beautiful Chaos</button>
        </div>
        
        <div id="resultContainer" class="result-container">
            <div class="result-glitch-overlay"></div>
            <!-- Results will be inserted here -->
        </div>
    </div>
    
    <div class="sparkles" id="sparkles"></div>
    
    <script>
        // Enhanced Hat Dialogue System
        const hatDialogues = {
            intro: [
                "Ah... another soul seeking categorization...",
                "I can smell your neurodivergence from here...",
                "This should be... interesting...",
                "Let's see what kind of beautiful chaos you are..."
            ],
            during: [
                "Fascinating... utterly fascinating...",
                "Your executive dysfunction is palpable...",
                "I see... very revealing...",
                "The patterns are becoming clear...",
                "Hmm... this explains a lot...",
                "Your dopamine levels are concerning...",
                "I've seen this before... many times...",
                "The chaos is strong with this one...",
                "Interesting choice... very telling...",
                "Your trauma responses are showing..."
            ],
            reveal: [
                "And there we have it...",
                "Your destiny is clear...",
                "I have spoken...",
                "The sorting is complete...",
                "Welcome to your new reality..."
            ]
        };

        const questions = [
            {
                question: "It's 2 AM and you suddenly remember you have a project due tomorrow. Your response:",
                options: [
                    "Panic, then start 47 different research tabs and somehow end up watching TikToks about medieval torture devices",
                    "Lie in bed catastrophizing about how this will ruin your entire future while your brain replays every embarrassing moment from 2003",
                    "Cry, make coffee, cry again, then produce the most brilliant work of your life fueled by pure anxiety and spite",
                    "Add it to your mental to-do list and take a 'quick' 6-hour nap to 'prepare your mind'"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 1, cryffindor: 1, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 3, cryffindor: 1, naptuffpuff: 1 },
                    { slackerin: 1, overthinkledore: 1, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 0, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "Your ideal productivity system involves:",
                options: [
                    "47 different apps, color-coded calendars, and a bullet journal you abandoned after 3 days but keep buying supplies for",
                    "Extensive research into productivity methods while never actually implementing any of them",
                    "Screaming into the void until motivation materializes, then working for 14 hours straight",
                    "A very detailed plan that you'll definitely start tomorrow... or next Monday... or January 1st"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 1, cryffindor: 0, naptuffpuff: 1 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 1 },
                    { slackerin: 0, overthinkledore: 0, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 1, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "When someone says 'just focus,' you:",
                options: [
                    "Explain that's like telling someone to 'just fly' while secretly starting 3 new projects",
                    "Spiral into an existential crisis about the nature of attention and write a 47-page analysis",
                    "Laugh maniacally while your eye twitches and you aggressively organize your desk",
                    "Nod and then immediately forget what you were supposed to focus on"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 0, cryffindor: 1, naptuffpuff: 1 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 1, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 0, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "Your relationship with deadlines is best described as:",
                options: [
                    "A chaotic dance where I start 12 things and finish them in the last 30 minutes using pure adrenaline",
                    "A philosophical nightmare where I contemplate whether time is even real while missing every single one",
                    "An emotional rollercoaster that ends with me producing Oscar-worthy work while having a breakdown",
                    "What deadlines? I'll deal with that after this nap... and maybe some snacks"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 0, cryffindor: 1, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 1 },
                    { slackerin: 0, overthinkledore: 1, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 0, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "Your brain at 3 AM typically:",
                options: [
                    "Decides NOW is the perfect time to reorganize your entire life, learn mandarin, and start that novel",
                    "Replays every conversation you've ever had and analyzes whether that person from 2015 secretly hates you",
                    "Oscillates between 'I'M A GENIUS' and 'I'M A DISASTER' every 12 seconds",
                    "Finally achieves perfect clarity about your life goals right before you fall asleep and forget everything"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 1, cryffindor: 0, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 3, cryffindor: 1, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 1, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 1, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "When hyperfocusing, you:",
                options: [
                    "Become the world's leading expert on medieval cat paintings while your laundry becomes sentient",
                    "Research the perfect way to do something for 6 hours instead of just doing the thing",
                    "Channel the energy of a thousand suns into the most random task while everything else burns",
                    "What's hyperfocusing? I was too busy thinking about what snack to have next"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 1, cryffindor: 0, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 0, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 0, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "Your approach to multitasking:",
                options: [
                    "I have 17 projects open, 3 podcasts playing, and I'm somehow also texting while making art",
                    "I research the optimal multitasking strategies while procrastinating on the actual tasks",
                    "I aggressively switch between tasks every 30 seconds while having an emotional breakdown about efficiency",
                    "I think about doing multiple things while doing absolutely nothing"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 0, cryffindor: 1, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 1 },
                    { slackerin: 1, overthinkledore: 1, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 1, cryffindor: 0, naptuffpuff: 3 }
                ]
            },
            {
                question: "When you find a new interest, you:",
                options: [
                    "Buy all the supplies, join 12 forums, and abandon it for the next shiny thing within a week",
                    "Research it obsessively for months but never actually start because you need to find the 'perfect' way to begin",
                    "Dive in headfirst with manic energy, become temporarily obsessed, then burn out spectacularly",
                    "Add it to your ever-growing list of 'things I'll definitely do someday' and take a nap"
                ],
                weights: [
                    { slackerin: 3, overthinkledore: 0, cryffindor: 1, naptuffpuff: 0 },
                    { slackerin: 1, overthinkledore: 3, cryffindor: 0, naptuffpuff: 1 },
                    { slackerin: 1, overthinkledore: 0, cryffindor: 3, naptuffpuff: 0 },
                    { slackerin: 0, overthinkledore: 1, cryffindor: 0, naptuffpuff: 3 }
                ]
            }
        ];
        
        const houses = {
            slackerin: {
                name: "SLACKERIN",
                color: "#27ae60",
                description: "Congratulations! You're the person who starts 47 different projects and finishes exactly 0.3 of them. Your browser has 127 tabs open, your Notes app is a beautiful disaster of half-formed genius, and you've convinced yourself that buying organizational supplies counts as being organized. You're not lazy—you're just operating on a different dimensional plane where time is a social construct and motivation is a cryptid. Your superpower is turning simple tasks into elaborate adventures.",
                motto: "Why finish one thing perfectly when you can start seventeen things magnificently?",
                traits: {
                    "Creative Chaos": "95%",
                    "Project Hoarding": "∞%",
                    "Completion Rate": "12%",
                    "Enthusiasm": "∞%"
                }
            },
            overthinkledore: {
                name: "OVERTHINKLEDORE",
                color: "#3498db",
                description: "Welcome to the house of beautiful mental spirals! You've turned overthinking into an art form that would make Inception look like a children's book. While others make decisions, you're busy constructing elaborate mental scenarios about every possible outcome, including the one where your coffee order somehow leads to the downfall of civilization. You have PhD-level expertise in analyzing text messages and can find 47 different meanings in 'ok.' Your brain is basically a supercomputer running on anxiety and perfectionism.",
                motto: "Why make a decision when you can spend 6 hours researching the optimal way to make decisions?",
                traits: {
                    "Analysis Paralysis": "99%",
                    "Scenario Planning": "∞%",
                    "Decision Speed": "0.1%",
                    "Accuracy Rate": "94%"
                }
            },
            cryffindor: {
                name: "CRYFFINDOR",
                color: "#e74c3c",
                description: "You're brave enough to schedule 17 tasks in one day and emotional enough to have a breakdown about it! Your life is a beautiful chaos of ambitious planning followed by spectacular meltdowns, but somehow you always pull through with work that's either pure genius or pure chaos—there's no in-between. You cry, you conquer, you question your life choices, repeat. Your emotional range spans from 'I AM UNSTOPPABLE' to 'I AM A DISASTER' with no middle ground. You're basically a feelings volcano with a productivity complex.",
                motto: "Boldly sobbing through life, one impossible deadline at a time!",
                traits: {
                    "Emotional Range": "∞%",
                    "Ambitious Planning": "98%",
                    "Breakdown Frequency": "Daily",
                    "Comeback Power": "Legendary"
                }
            },
            naptuffpuff: {
                name: "NAPTUFFPUFF",
                color: "#f39c12",
                description: "You've mastered the ancient art of Strategic Procrastination and elevated it to a spiritual practice. Why do today what you can do tomorrow? Why do tomorrow what you can do next week? Your motto is 'I'll be productive after this nap,' and that nap happened 6 months ago. You're not avoiding responsibility—you're just charging your social battery... indefinitely. Your ideal day involves pajamas, snacks, and exactly zero human interaction. You've achieved enlightenment through the power of 'later.'",
                motto: "I'm not procrastinating, I'm incubating my potential!",
                traits: {
                    "Procrastination Mastery": "99%",
                    "Nap Optimization": "100%",
                    "Energy Conservation": "Expert",
                    "Task Completion": "Eventually™"
                }
            }
        };
        
        let currentQuestion = 0;
        let scores = { slackerin: 0, overthinkledore: 0, cryffindor: 0, naptuffpuff: 0 };
        let selectedAnswer = null;
        let hudCollapsed = false;
        let dialogueTimeout = null;
        
        // Mobile detection
        function isMobile() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Enhanced Hat Dialogue System
        function showHatDialogue(message, duration = 3000) {
            const bubble = document.getElementById('hatSpeechBubble');
            const hat = document.getElementById('sortingHat');
            
            if (dialogueTimeout) {
                clearTimeout(dialogueTimeout);
            }
            
            // Typing animation
            bubble.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>';
            bubble.classList.add('show');
            hat.classList.add('talking');
            
            // Show actual message after typing delay
            setTimeout(() => {
                bubble.textContent = message;
                
                // Hide after duration
                dialogueTimeout = setTimeout(() => {
                    bubble.classList.remove('show');
                    hat.classList.remove('talking');
                }, duration);
            }, 1000);
        }
        
        // Intro sequence
        function startIntroSequence() {
            const introOverlay = document.getElementById('introOverlay');
            const orientationModal = document.getElementById('orientationModal');
            
            // Start with hat dialogue
            setTimeout(() => {
                showHatDialogue("I see into your soul... but it's blurry.");
            }, 1000);
            
            // Handle intro click
            introOverlay.addEventListener('click', () => {
                introOverlay.classList.add('fade-out');
                
                setTimeout(() => {
                    introOverlay.style.display = 'none';
                    orientationModal.classList.add('show');
                    showHatDialogue("Prepare for aggressive personality categorization...", 4000);
                }, 2000);
            });
            
            // Auto-advance after 8 seconds if no interaction
            setTimeout(() => {
                if (!introOverlay.classList.contains('fade-out')) {
                    introOverlay.click();
                }
            }, 8000);
        }
        
        // Mobile HUD Management
        function initMobileHUD() {
            const hudToggle = document.getElementById('hudToggle');
            const hudContent = document.getElementById('hudContent');
            
            if (isMobile()) {
                hudCollapsed = true;
                hudContent.classList.add('hud-collapsed');
                hudToggle.textContent = '⏬';
            }
            
            hudToggle.addEventListener('click', () => {
                hudCollapsed = !hudCollapsed;
                
                if (hudCollapsed) {
                    hudContent.classList.add('hud-collapsed');
                    hudToggle.textContent = '⏬';
                } else {
                    hudContent.classList.remove('hud-collapsed');
                    hudToggle.textContent = '⏫';
                }
                
                // Haptic feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            });
        }
        
        // Enhanced progress and chaos tracking
        function updateChaosLevel() {
            const total = Object.values(scores).reduce((a, b) => a + b, 0);
            const chaos = Math.min(100, (total / (questions.length * 3)) * 100);
            document.getElementById('chaosLevel').textContent = Math.round(chaos) + '%';
            document.getElementById('chaosFill').style.width = chaos + '%';
            
            // Dynamic hat commentary based on chaos level
            if (chaos >= 75) {
                showHatDialogue("Your chaos levels are off the charts!", 2000);
            } else if (chaos >= 50) {
                showHatDialogue("The patterns are becoming clear...", 2000);
            }
        }
        
        // Enhanced question display
        function displayQuestion() {
            if (currentQuestion >= questions.length) {
                showResult();
                return;
            }
            
            const question = questions[currentQuestion];
            const container = document.getElementById('questionContainer');
            
            // Hat commentary for each question
            if (currentQuestion === 0) {
                showHatDialogue(hatDialogues.intro[Math.floor(Math.random() * hatDialogues.intro.length)], 3000);
            } else {
                const duringDialogue = hatDialogues.during[Math.floor(Math.random() * hatDialogues.during.length)];
                showHatDialogue(duringDialogue, 2500);
            }
            
            container.innerHTML = `
                <div class="question">
                    <div class="question-number">Question ${currentQuestion + 1}/${questions.length}</div>
                    <h3 class="question-text">${question.question}</h3>
                    <div class="options">
                        ${question.options.map((option, index) => `
                            <div class="option" data-index="${index}">
                                ${option}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            // Add option handlers
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedAnswer = parseInt(option.dataset.index);
                    document.getElementById('nextBtn').classList.remove('hidden');
                    
                    // Haptic feedback
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                });
            });
            
            // Update progress
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            updateChaosLevel();
        }
        
        // Enhanced result reveal
        function showResult() {
            document.getElementById('quizContainer').style.display = 'none';
            
            // Find winning house
            const winningHouse = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const house = houses[winningHouse];
            
            // Hat's final commentary
            const revealDialogue = hatDialogues.reveal[Math.floor(Math.random() * hatDialogues.reveal.length)];
            showHatDialogue(revealDialogue, 4000);
            
            const resultContainer = document.getElementById('resultContainer');
            resultContainer.className = `result-container house-${winningHouse}`;
            
            const statsHtml = Object.entries(house.traits).map(([key, value]) => `
                <div class="stat-item">
                    <div class="stat-label">${key}</div>
                    <div class="stat-value">${value}</div>
                </div>
            `).join('');
            
            resultContainer.innerHTML = `
                <div class="hat-dialogue-container">
                    <div class="hat-animation">
                        <div class="hat-speech-bubble" id="resultHatSpeech"></div>
                    </div>
                </div>
                <h2 class="house-name">${house.name}</h2>
                <p class="house-description">${house.description}</p>
                <p class="house-motto">"${house.motto}"</p>
                
                <div class="house-stats">
                    ${statsHtml}
                </div>
                
                <button class="btn" onclick="restartQuiz()">Dare Me to Sort You Again?</button>
                <button class="btn" onclick="shareResult()">Share Your Beautiful Disaster</button>
                <button class="btn" onclick="screenshotMode()">📸 Screenshot Mode</button>
            `;
            
            resultContainer.style.display = 'block';
            
            // Show screenshot prompt
            setTimeout(() => {
                const screenshotPrompt = document.getElementById('screenshotPrompt');
                screenshotPrompt.classList.add('show');
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    screenshotPrompt.classList.remove('show');
                }, 10000);
            }, 2000);
            
            // Celebration effects
            setTimeout(() => {
                createCelebrationEffect(house.color);
            }, 1000);
            
            // Final hat commentary
            setTimeout(() => {
                const resultSpeech = document.querySelector('#resultHatSpeech');
                if (resultSpeech) {
                    showResultDialogue("Your fate is sealed. The chaos is complete.", resultSpeech);
                }
            }, 3000);
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showResultDialogue(message, element) {
            element.innerHTML = '<span class="typing-indicator"></span><span class="typing-indicator"></span><span class="typing-indicator"></span>';
            element.classList.add('show');
            
            setTimeout(() => {
                element.textContent = message;
            }, 1000);
        }
        
        // Enhanced celebration effects
        function createCelebrationEffect(color) {
            const particleCount = isMobile() ? 50 : 100;
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    createCelebrationParticle(color);
                }, i * 50);
            }
            
            // Create sparkles
            createSparkles();
        }
        
        function createCelebrationParticle(color) {
            const particle = document.createElement('div');
            particle.style.position = 'fixed';
            particle.style.width = (4 + Math.random() * 8) + 'px';
            particle.style.height = (4 + Math.random() * 8) + 'px';
            particle.style.background = color;
            particle.style.borderRadius = '50%';
            particle.style.left = Math.random() * window.innerWidth + 'px';
            particle.style.top = '-10px';
            particle.style.pointerEvents = 'none';
            particle.style.zIndex = '1000';
            particle.style.boxShadow = `0 0 10px ${color}`;
            
            document.body.appendChild(particle);
            
            const animation = particle.animate([
                { 
                    transform: 'translateY(0px) rotate(0deg)', 
                    opacity: 1,
                    scale: 1
                },
                { 
                    transform: `translateY(${window.innerHeight + 100}px) rotate(${720 + Math.random() * 720}deg)`, 
                    opacity: 0,
                    scale: 0.5
                }
            ], {
                duration: 2000 + Math.random() * 3000,
                easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
            });
            
            animation.onfinish = () => particle.remove();
        }
        
        function createSparkles() {
            const sparklesContainer = document.getElementById('sparkles');
            sparklesContainer.innerHTML = '';
            
            const sparkleCount = isMobile() ? 15 : 30;
            
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                sparkle.style.animationDuration = (1 + Math.random() * 2) + 's';
                sparklesContainer.appendChild(sparkle);
            }
        }
        
        // Quiz flow functions
        function startQuiz() {
            document.getElementById('orientationModal').classList.remove('show');
            document.getElementById('startBtn').style.display = 'none';
            currentQuestion = 0;
            scores = { slackerin: 0, overthinkledore: 0, cryffindor: 0, naptuffpuff: 0 };
            displayQuestion();
        }
        
        function nextQuestion() {
            if (selectedAnswer === null) return;
            
            // Update scores
            const weights = questions[currentQuestion].weights[selectedAnswer];
            Object.keys(weights).forEach(house => {
                scores[house] += weights[house];
            });
            
            selectedAnswer = null;
            currentQuestion++;
            document.getElementById('nextBtn').classList.add('hidden');
            
            setTimeout(displayQuestion, 300);
        }
        
        function restartQuiz() {
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('startBtn').style.display = 'inline-flex';
            document.getElementById('screenshotPrompt').classList.remove('show');
            currentQuestion = 0;
            scores = { slackerin: 0, overthinkledore: 0, cryffindor: 0, naptuffpuff: 0 };
            selectedAnswer = null;
            document.getElementById('progressFill').style.width = '0%';
            updateChaosLevel();
            
            // Reset hat dialogue
            const bubble = document.getElementById('hatSpeechBubble');
            bubble.classList.remove('show');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function shareResult() {
            const winningHouse = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            const text = `I just got sorted into ${houses[winningHouse].name} by the Distorting Hat! 🎭 "${houses[winningHouse].motto}" - My soul has been categorized and it's concerning.`;
            
            if (navigator.share && isMobile()) {
                navigator.share({ 
                    title: 'The Distorting Hat™',
                    text: text,
                    url: window.location.href
                }).catch(() => {
                    copyToClipboard(text);
                });
            } else {
                copyToClipboard(text);
            }
        }
        
        function screenshotMode() {
            const screenshotPrompt = document.getElementById('screenshotPrompt');
            screenshotPrompt.classList.add('show');
            
            // Hide HUD for cleaner screenshot
            if (!hudCollapsed) {
                document.getElementById('hudToggle').click();
            }
            
            // Enhanced screenshot prompt
            screenshotPrompt.innerHTML = '📸 Perfect! Your chaos is now ready for the world to see. Screenshot before the hat changes its mind!';
            
            setTimeout(() => {
                screenshotPrompt.classList.remove('show');
            }, 8000);
        }
        
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showHatDialogue("Your chaos has been copied to the clipboard. Spread the madness!", 3000);
                });
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showHatDialogue("Your chaos has been copied! Share your beautiful disaster!", 3000);
            }
        }
        
        // Event listeners
        document.getElementById('beginDistortion').addEventListener('click', startQuiz);
        document.getElementById('startBtn').addEventListener('click', startQuiz);
        document.getElementById('nextBtn').addEventListener('click', nextQuestion);
        
        // Hat click interaction
        document.addEventListener('click', (e) => {
            if (e.target.closest('.hat-animation') || e.target.closest('.distorting-hat')) {
                const phrases = [
                    "Stop poking me!",
                    "I'm trying to concentrate here...",
                    "Your soul is still blurry, by the way.",
                    "Have you considered therapy?",
                    "I see... everything...",
                    "Your chaos is showing.",
                    "This is why I drink.",
                    "Still as confused as ever, I see."
                ];
                const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
                showHatDialogue(randomPhrase, 2000);
                
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }
            }
        });
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initMobileHUD();
            updateChaosLevel();
            createSparkles();
            startIntroSequence();
            
            // Orientation change handler
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    createSparkles();
                }, 500);
            });
            
            // Prevent zoom on iOS
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });
        
        // Random chaos effects
        setInterval(() => {
            if (Math.random() < 0.1) {
                const pill = document.createElement('div');
                pill.className = 'floating-pill';
                pill.style.left = Math.random() * 100 + '%';
                pill.style.top = '-50px';
                pill.style.width = (20 + Math.random() * 20) + 'px';
                pill.style.height = (10 + Math.random() * 10) + 'px';
                pill.style.background = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.3)`;
                pill.style.borderRadius = '50px';
                pill.style.animation = `float ${4 + Math.random() * 4}s ease-in-out infinite`;
                
                document.querySelector('.floating-elements').appendChild(pill);
                
                setTimeout(() => pill.remove(), 8000);
            }
        }, isMobile() ? 8000 : 5000);
    </script>
</body>
</html>
